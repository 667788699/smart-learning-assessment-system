{% extends "base.html" %}

{% block title %}數據分析 - {{ child.nickname }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    {{ child.nickname }} 的學習數據分析
                </h2>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>返回學習中心
                </a>
            </div>
        </div>
    </div>
    
    <!-- 統計概覽 -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="stats-card bg-primary text-white">
                <i class="fas fa-calendar-check"></i>
                <h4>{{ study_sessions|length }}</h4>
                <p class="mb-0">總學習次數</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card bg-success text-white">
                <i class="fas fa-clock"></i>
                <h4>
                    {% set total_minutes = study_sessions | map(attribute='duration_minutes') | sum %}
                    {{ "%.1f" | format(total_minutes / 60) }}
                </h4>
                <p class="mb-0">總學習時數</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card bg-info text-white">
                <i class="fas fa-brain"></i>
                <h4>
                    {% if study_sessions %}
                        {% set attention_sessions = study_sessions | selectattr('avg_attention') | list %}
                        {% if attention_sessions %}
                            {{ "%.0f" | format((attention_sessions | map(attribute='avg_attention') | sum / attention_sessions|length) * 100 / 3) }}%
                        {% else %}
                            --
                        {% endif %}
                    {% else %}
                        --
                    {% endif %}
                </h4>
                <p class="mb-0">平均專注度</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card bg-warning text-white">
                <i class="fas fa-trophy"></i>
                <h4>
                    {% if chart_data.subjects %}
                        {{ chart_data.subjects[0] }}
                    {% else %}
                        --
                    {% endif %}
                </h4>
                <p class="mb-0">最常學習科目</p>
            </div>
        </div>
    </div>
    
    <!-- 圖表區域 -->
    <div class="row">
        <!-- 科目學習時間分布 -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        科目學習時間分布
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="subjectTimeChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 科目專注度比較 -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar text-success me-2"></i>
                        科目專注度比較
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="subjectAttentionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 專注度趨勢圖 -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-info me-2"></i>
                        最近10次學習專注度趨勢
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="attentionTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 詳細學習記錄 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-warning me-2"></i>
                        詳細學習記錄
                    </h5>
                    <button class="btn btn-danger btn-sm" onclick="resetLearningHistory()">
                        <i class="fas fa-redo me-1"></i>重置所有記錄
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>日期時間</th>
                                    <th>科目</th>
                                    <th>學習時長</th>
                                    <th>平均專注度</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in study_sessions %}
                                <tr>
                                    <td>{{ session.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <span class="badge bg-primary">
                                            {{ {'math': '數學', 'science': '自然科學', 'language': '語言文學', 
                                                'social': '社會科學', 'art': '藝術創作', 'cs': '電腦科學'}[session.subject] }}
                                        </span>
                                    </td>
                                    <td>{{ session.duration_minutes }} 分鐘</td>
                                    <td>
                                        {% if session.avg_attention %}
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar 
                                                    {% if session.avg_attention >= 2.5 %}bg-success
                                                    {% elif session.avg_attention >= 1.5 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ (session.avg_attention / 3 * 100) }}%">
                                                    {{ "%.0f" | format(session.avg_attention * 100 / 3) }}%
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if session.end_time %}
                                            <span class="badge bg-success">已完成</span>
                                        {% else %}
                                            <span class="badge bg-warning">進行中</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteSession({{ session.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 日曆檢視 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                        學習日曆
                    </h5>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="btn btn-sm btn-outline-primary" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h6 id="currentMonth" class="mb-0"></h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="changeMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 確認重置模態框 -->
<div class="modal fade" id="confirmResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">確認重置學習記錄</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>確定要重置 {{ child.nickname }} 的所有學習記錄嗎？此操作無法復原。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmReset()">確認重置</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 圖表數據
const chartData = {{ chart_data | tojson }};

// 設定圖表預設字體大小
Chart.defaults.font.size = 14;

// 科目學習時間分布圖
const subjectTimeCtx = document.getElementById('subjectTimeChart').getContext('2d');
new Chart(subjectTimeCtx, {
    type: 'pie',
    data: {
        labels: chartData.subjects,
        datasets: [{
            data: chartData.study_times,
            backgroundColor: [
                '#3498DB',
                '#2ECC71',
                '#E74C3C',
                '#F39C12',
                '#9B59B6',
                '#1ABC9C'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    font: {
                        size: 14
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + ' 分鐘';
                    }
                }
            }
        }
    }
});

// 科目專注度比較圖
const subjectAttentionCtx = document.getElementById('subjectAttentionChart').getContext('2d');
new Chart(subjectAttentionCtx, {
    type: 'bar',
    data: {
        labels: chartData.subjects,
        datasets: [{
            label: '平均專注度 (%)',
            data: chartData.attention_scores,
            backgroundColor: chartData.attention_scores.map(score => {
                if (score >= 80) return '#2ECC71';
                if (score >= 60) return '#F39C12';
                return '#E74C3C';
            }),
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '專注度: ' + context.parsed.y + '%';
                    }
                }
            }
        }
    }
});

// 專注度趨勢圖
const attentionTrendCtx = document.getElementById('attentionTrendChart').getContext('2d');
new Chart(attentionTrendCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: '專注度 (%)',
            data: chartData.attention_trend,
            borderColor: '#3498DB',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: '#3498DB',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '專注度: ' + context.parsed.y + '%';
                    }
                }
            }
        }
    }
});

// 重置學習記錄
function resetLearningHistory() {
    const modal = new bootstrap.Modal(document.getElementById('confirmResetModal'));
    modal.show();
}

async function confirmReset() {
    try {
        const response = await fetch(`/reset_learning_history/{{ child.id }}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('學習記錄已重置');
            window.location.reload();
        } else {
            alert('重置失敗');
        }
    } catch (error) {
        alert('重置失敗，請稍後再試');
    }
}

// 刪除單一學習記錄
async function deleteSession(sessionId) {
    if (!confirm('確定要刪除這筆學習記錄嗎？')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete_session/${sessionId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('刪除失敗');
        }
    } catch (error) {
        alert('刪除失敗，請稍後再試');
    }
}

// 日曆功能
let currentDate = new Date();
const studySessions = {{ study_sessions | tojson }};

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // 更新月份標題
    const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                       '七月', '八月', '九月', '十月', '十一月', '十二月'];
    document.getElementById('currentMonth').textContent = `${year}年 ${monthNames[month]}`;
    
    // 清空日曆
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    
    // 添加星期標題
    const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
    weekDays.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day text-center fw-bold';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });
    
    // 獲取月份第一天和最後一天
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startPadding = firstDay.getDay();
    
    // 填充空白日期
    for (let i = 0; i < startPadding; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarGrid.appendChild(emptyDay);
    }
    
    // 填充日期
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        // 檢查是否有學習記錄
        const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const sessionsOnDay = studySessions.filter(session => {
            const sessionDate = session.start_time.split('T')[0];
            return sessionDate === currentDateStr;
        });
        
        if (sessionsOnDay.length > 0) {
            dayElement.classList.add('has-data');
            const indicator = document.createElement('div');
            indicator.className = 'study-indicator';
            dayElement.appendChild(indicator);
            
            // 點擊顯示當天學習詳情
            dayElement.onclick = () => showDayDetails(currentDateStr, sessionsOnDay);
        }
        
        calendarGrid.appendChild(dayElement);
    }
}

function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    renderCalendar();
}

function showDayDetails(date, sessions) {
    let details = `${date} 的學習記錄：\n\n`;
    sessions.forEach(session => {
        const subject = {'math': '數學', 'science': '自然科學', 'language': '語言文學', 
                        'social': '社會科學', 'art': '藝術創作', 'cs': '電腦科學'}[session.subject];
        const attention = session.avg_attention ? 
            Math.round(session.avg_attention * 100 / 3) + '%' : '未記錄';
        details += `科目：${subject}\n`;
        details += `時長：${session.duration_minutes} 分鐘\n`;
        details += `專注度：${attention}\n\n`;
    });
    alert(details);
}

// 初始化日曆
document.addEventListener('DOMContentLoaded', function() {
    renderCalendar();
});
</script>

<style>
.stats-card {
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.stats-card i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.9;
}

.stats-card h4 {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

canvas {
    max-height: 400px;
}

.table-responsive {
    max-height: 500px;
    overflow-y: auto;
}

.progress {
    background-color: #e9ecef;
}
</style>
{% endblock %}
