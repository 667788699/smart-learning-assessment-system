{% extends "base.html" %}

{% block title %}選擇學習檔案 - 智慧學習評估系統{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4 text-center">
                <i class="fas fa-users text-primary me-2"></i>
                選擇學習檔案
            </h2>
            <p class="text-center text-muted mb-5">
                請選擇要進入的學習環境，或建立新的學習檔案
            </p>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <!-- 現有小孩檔案 -->
        {% for child in children %}
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card child-card h-100" onclick="selectChild({{ child.id }})">
                <div class="card-body text-center">
                    <div class="child-avatar mb-3">
                        {% if child.gender == 'male' %}
                            <i class="fas fa-user-astronaut fa-4x text-primary"></i>
                        {% else %}
                            <i class="fas fa-user-graduate fa-4x text-danger"></i>
                        {% endif %}
                    </div>
                    <h5 class="card-title">{{ child.nickname }}</h5>
                    <p class="card-text text-muted">
                        {{ child.age }}歲 • {{ {'elementary': '國小', 'middle': '國中', 'high': '高中'}[child.education_stage] }}
                    </p>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); selectChild({{ child.id }})">
                            <i class="fas fa-sign-in-alt me-1"></i>進入
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteChild({{ child.id }}, '{{ child.nickname }}')">
                            <i class="fas fa-trash me-1"></i>刪除
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- 新增小孩按鈕 -->
        {% if children|length < 4 %}
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card add-child-card h-100" data-bs-toggle="modal" data-bs-target="#createChildModal">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-plus-circle fa-4x text-success mb-3"></i>
                    <h5 class="card-title">新增學習檔案</h5>
                    <p class="card-text text-muted">最多可建立4個檔案</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 帳號管理 -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <button class="btn btn-outline-danger" onclick="deleteAccount()">
                <i class="fas fa-user-times me-2"></i>刪除整個帳號
            </button>
        </div>
    </div>
</div>

<!-- 創建小孩模態框 -->
<div class="modal fade" id="createChildModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus text-primary me-2"></i>
                    建立新的學習檔案
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createChildForm">
                    <div class="mb-3">
                        <label for="nickname" class="form-label">暱稱</label>
                        <input type="text" class="form-control" id="nickname" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">性別</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="gender" id="male" value="male" checked>
                            <label class="btn btn-outline-primary" for="male">
                                <i class="fas fa-mars me-1"></i>男生
                            </label>
                            
                            <input type="radio" class="btn-check" name="gender" id="female" value="female">
                            <label class="btn btn-outline-danger" for="female">
                                <i class="fas fa-venus me-1"></i>女生
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="age" class="form-label">年齡</label>
                        <input type="number" class="form-control" id="age" min="6" max="18" required 
                               oninput="validateAge(this)">
                        <div class="invalid-feedback">
                            年齡必須在6-18歲之間
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="education_stage" class="form-label">教育階段</label>
                        <select class="form-select" id="education_stage" required>
                            <option value="">請選擇</option>
                            <option value="elementary">國小</option>
                            <option value="middle">國中</option>
                            <option value="high">高中</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createChild()">
                    <i class="fas fa-save me-2"></i>建立
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 確認刪除模態框 -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">確認刪除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">確認刪除</button>
            </div>
        </div>
    </div>
</div>

<style>
.child-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.child-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.add-child-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px dashed #28a745;
    background-color: rgba(40, 167, 69, 0.05);
}

.add-child-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(40, 167, 69, 0.2);
    background-color: rgba(40, 167, 69, 0.1);
}

.child-avatar {
    width: 100px;
    height: 100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 50%;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function validateAge(input) {
    const age = parseInt(input.value);
    if (age < 6 || age > 18) {
        input.classList.add('is-invalid');
        if (age < 6) input.value = 6;
        if (age > 18) input.value = 18;
    } else {
        input.classList.remove('is-invalid');
    }
}

function selectChild(childId) {
    window.location.href = `/select_child/${childId}`;
}

async function createChild() {
    const nickname = document.getElementById('nickname').value;
    const gender = document.querySelector('input[name="gender"]:checked').value;
    const age = parseInt(document.getElementById('age').value);
    const education_stage = document.getElementById('education_stage').value;
    
    if (!nickname || !age || !education_stage) {
        alert('請填寫所有欄位');
        return;
    }
    
    if (age < 6 || age > 18) {
        alert('年齡必須在6-18歲之間');
        return;
    }
    
    try {
        const response = await fetch('/create_child', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nickname: nickname,
                gender: gender,
                age: age,
                education_stage: education_stage
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = `/select_child/${result.child_id}`;
        } else {
            alert(result.message || '建立失敗');
        }
    } catch (error) {
        console.error('Create child error:', error);
        alert('建立失敗，請稍後再試');
    }
}

function deleteChild(childId, nickname) {
    document.getElementById('deleteMessage').textContent = `確定要刪除 ${nickname} 的學習檔案嗎？所有學習記錄將會被永久刪除。`;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show();
    
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            const response = await fetch(`/delete_child/${childId}`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.location.reload();
            } else {
                alert('刪除失敗');
            }
        } catch (error) {
            console.error('Delete child error:', error);
            alert('刪除失敗，請稍後再試');
        }
    };
}

async function deleteAccount() {
    if (!confirm('確定要刪除整個帳號嗎？這將刪除您的帳號和所有小孩的學習記錄，此操作無法復原。')) {
        return;
    }
    
    if (!confirm('請再次確認：您真的要刪除整個帳號嗎？')) {
        return;
    }
    
    try {
        const response = await fetch('/delete_account', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('帳號已刪除');
            window.location.href = '/';
        } else {
            alert('刪除失敗');
        }
    } catch (error) {
        console.error('Delete account error:', error);
        alert('刪除失敗，請稍後再試');
    }
}
</script>
{% endblock %}
